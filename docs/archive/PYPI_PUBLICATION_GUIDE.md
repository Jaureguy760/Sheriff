# PyPI Publication Guide for Sheriff v1.2.0

## Package Status

✅ **Package Built Successfully**
- Source Distribution: `sheriff-1.2.0.tar.gz` (7.5MB)
- Wheel: `sheriff-1.2.0-py3-none-any.whl` (45KB)
- Build validated with `python -m build`

⚠️ **Minor Metadata Warning**
- Twine shows warning about deprecated `License-File` field
- This is auto-generated by setuptools and won't prevent PyPI upload
- PyPI accepts this metadata format (PEP 621 compliant)

---

## Prerequisites

### 1. Create PyPI Account

**TestPyPI** (for testing):
1. Go to https://test.pypi.org/account/register/
2. Verify email
3. Enable 2FA (required)

**Production PyPI**:
1. Go to https://pypi.org/account/register/
2. Verify email
3. Enable 2FA (required)

### 2. Create API Tokens

**TestPyPI**:
1. Go to https://test.pypi.org/manage/account/token/
2. Click "Add API token"
3. Name: "Sheriff Upload"
4. Scope: "Entire account" (or specific to Sheriff project)
5. Copy token (starts with `pypi-`)
6. Store securely

**Production PyPI**:
1. Go to https://pypi.org/manage/account/token/
2. Repeat same process
3. Store both tokens securely

### 3. Configure Credentials

**Option A: Using `.pypirc` file**

Create `~/.pypirc`:

```ini
[distutils]
index-servers =
    pypi
    testpypi

[pypi]
username = __token__
password = pypi-YOUR_PRODUCTION_TOKEN_HERE

[testpypi]
repository = https://test.pypi.org/legacy/
username = __token__
password = pypi-YOUR_TEST_TOKEN_HERE
```

Set permissions:
```bash
chmod 600 ~/.pypirc
```

**Option B: Environment Variables**

```bash
export TWINE_USERNAME=__token__
export TWINE_PASSWORD=pypi-YOUR_TOKEN_HERE
```

**Option C: GitHub Secrets** (for CI/CD)

Add to repository secrets:
- `PYPI_API_TOKEN`
- `TEST_PYPI_API_TOKEN`

---

## Publication Process

### Step 1: Test Build Locally

```bash
# Clean previous builds
rm -rf dist/ build/ *.egg-info

# Build package
python -m build

# Verify build
ls -lh dist/
# Should show:
# sheriff-1.2.0-py3-none-any.whl
# sheriff-1.2.0.tar.gz

# Check package (ignore License-File warning)
twine check dist/*
```

### Step 2: Publish to TestPyPI

```bash
# Upload to TestPyPI
twine upload --repository testpypi dist/*

# Expected output:
# Uploading distributions to https://test.pypi.org/legacy/
# Uploading sheriff-1.2.0-py3-none-any.whl
# Uploading sheriff-1.2.0.tar.gz
# View at:
# https://test.pypi.org/project/sheriff/1.2.0/
```

### Step 3: Test Installation from TestPyPI

```bash
# Create clean test environment
python -m venv test-env
source test-env/bin/activate  # On Windows: test-env\Scripts\activate

# Install from TestPyPI
pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ sheriff

# Note: --extra-index-url allows dependencies from production PyPI

# Test installation
python -c "import sheriff; print(sheriff.__version__)"
sheriff --help

# Run example (if you have data)
sheriff --version

# Deactivate and clean up
deactivate
rm -rf test-env
```

### Step 4: Publish to Production PyPI

**⚠️ IMPORTANT: This is permanent and cannot be undone!**

```bash
# Final check
twine check dist/*

# Upload to PyPI
twine upload dist/*

# Expected output:
# Uploading distributions to https://upload.pypi.org/legacy/
# Uploading sheriff-1.2.0-py3-none-any.whl
# Uploading sheriff-1.2.0.tar.gz
# View at:
# https://pypi.org/project/sheriff/1.2.0/
```

### Step 5: Verify Production Installation

```bash
# In a fresh environment
pip install sheriff

# Verify
python -c "import sheriff; print(sheriff.__version__)"
# Should print: 1.2.0

sheriff --help
# Should show Sheriff CLI help
```

---

## Automated GitHub Actions Publication

The repository already has `.github/workflows/publish.yml` configured for automatic publishing.

### Setup

1. Add GitHub Secrets:
   - Go to repository Settings → Secrets and variables → Actions
   - Add `PYPI_API_TOKEN` (production token)
   - Add `TEST_PYPI_API_TOKEN` (test token)

2. Create a release:
   ```bash
   git tag v1.2.0
   git push origin v1.2.0
   ```

3. GitHub Actions will automatically:
   - Build package
   - Run tests
   - Publish to PyPI
   - Create GitHub release notes

### Manual Trigger (TestPyPI)

```bash
# Trigger publish workflow manually
gh workflow run publish.yml
```

This will publish to TestPyPI instead of production.

---

## Post-Publication Steps

### 1. Update README Badges

Add to README.md:

```markdown
[![PyPI version](https://badge.fury.io/py/sheriff.svg)](https://pypi.org/project/sheriff/)
[![PyPI pyversions](https://img.shields.io/pypi/pyversions/sheriff.svg)](https://pypi.org/project/sheriff/)
[![PyPI downloads](https://img.shields.io/pypi/dm/sheriff.svg)](https://pypi.org/project/sheriff/)
```

### 2. Update Installation Instructions

Replace manual installation with:

```markdown
## Installation

### Quick Install (Recommended)

```bash
pip install sheriff
```

### With Rust Acceleration (10-100x speedup)

```bash
# Install Sheriff
pip install sheriff

# Install Rust toolchain
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env

# Install and build Rust module
pip install maturin
git clone https://github.com/BradBalderson/Sheriff.git
cd Sheriff/sheriff-rs
maturin develop --release
```
```

### 3. Announce Release

- Update documentation site
- Announce on Twitter/LinkedIn
- Post on relevant Slack channels/forums
- Update bioRxiv preprint if applicable

---

## Troubleshooting

### Problem: "File already exists" error

**Cause**: Version 1.2.0 already published to PyPI

**Solution**: Increment version in `pyproject.toml` and rebuild
```bash
# Edit pyproject.toml: version = "1.2.1"
rm -rf dist/ build/
python -m build
twine upload dist/*
```

### Problem: "Invalid credentials"

**Cause**: Wrong API token or expired token

**Solution**:
1. Regenerate token on PyPI website
2. Update `.pypirc` or environment variable
3. Ensure using `__token__` as username (with two underscores)

### Problem: "Metadata validation error"

**Cause**: Invalid pyproject.toml

**Solution**:
```bash
# Validate locally
pip install validate-pyproject
validate-pyproject pyproject.toml
```

### Problem: Dependencies not installing

**Cause**: Some dependencies (faiss-cpu, pysam) may need system libraries

**Solution**: Document system dependencies in README:
```markdown
## System Requirements

**Ubuntu/Debian:**
```bash
sudo apt-get install samtools
```

**macOS:**
```bash
brew install samtools
```
```

---

## Version Management

### Semantic Versioning

Sheriff follows [SemVer](https://semver.org/):

- **Major** (2.0.0): Breaking API changes
- **Minor** (1.3.0): New features, backward compatible
- **Patch** (1.2.1): Bug fixes, backward compatible

### Release Checklist

Before each release:

- [ ] Update version in `pyproject.toml`
- [ ] Update `CHANGELOG.md` with changes
- [ ] Run full test suite: `pytest tests/`
- [ ] Build package: `python -m build`
- [ ] Test locally: `pip install dist/*.whl`
- [ ] Commit version bump
- [ ] Create git tag: `git tag v1.x.x`
- [ ] Push tag: `git push origin v1.x.x`
- [ ] GitHub Actions publishes automatically
- [ ] Verify on PyPI
- [ ] Update documentation

---

## Success Metrics

After publication, monitor:

- **PyPI Stats**: https://pypi.org/project/sheriff/
- **Download Stats**: https://pypistats.org/packages/sheriff
- **GitHub Stars**: https://github.com/BradBalderson/Sheriff/stargazers
- **Issues**: https://github.com/BradBalderson/Sheriff/issues

---

## Current Status

✅ Package built and ready for publication
✅ GitHub Actions workflow configured
✅ Documentation complete
✅ Tests passing

**Ready to publish to PyPI!**

### Next Steps:

1. Create PyPI account (if not exists)
2. Generate API tokens
3. Run: `twine upload dist/*` (or push git tag for automatic publish)
4. Verify installation: `pip install sheriff`
5. Update README with PyPI badge
6. Announce release

---

## Notes

- The deprecation warning about `License-File` is cosmetic and won't prevent upload
- PyPI is case-insensitive, so "Sheriff" and "sheriff" are the same project
- Once published, that specific version cannot be re-uploaded (use patch version for fixes)
- TestPyPI has different database than production - package names don't conflict

---

**For questions or issues, contact: bbalderson@salk.edu**
